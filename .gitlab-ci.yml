include:
  - component: $CI_SERVER_FQDN/to-be-continuous/golang/gitlab-ci-golang@4.15.0

variables:
  GO_SBOM_OPTS: "-main cmd/migrate"
  IMAGE_NAME: "docker.io/${DOCKER_REGISTRY_USER}/migraptor"

stages:
  - build
  - test
  - package
  - security
  - publish

# Build Docker image
docker-build:
  stage: package
  image: docker:24-dind
  services:
    - docker:24-dind
  before_script: |
    # Compute image tag: use Git tag name if available, otherwise "dev"
    if [ -n "$CI_COMMIT_TAG" ]; then
      export IMAGE_TAG="$CI_COMMIT_REF_NAME"
      echo "Building release image with tag: $IMAGE_TAG"
    else
      export IMAGE_TAG="dev"
      echo "Building dev image with tag: $IMAGE_TAG"
    fi
    echo "Building Docker image: ${IMAGE_NAME}:${IMAGE_TAG}"
  script:
    - docker build -t ${IMAGE_NAME}:${IMAGE_TAG} .
    - docker tag ${IMAGE_NAME}:${IMAGE_TAG} ${IMAGE_NAME}:latest
    - echo "Saving image for Trivy scanning..."
    - docker save ${IMAGE_NAME}:${IMAGE_TAG} -o image.tar
    - echo "Docker image built successfully"
  artifacts:
    paths:
      - image.tar
    expire_in: 1 hour
  only:
    - branches
    - tags

# Security scan with Trivy
trivy-scan:
  stage: security
  image: aquasec/trivy:latest
  dependencies:
    - docker-build
  before_script: |
    # Compute image tag: use Git tag name if available, otherwise "dev"
    if [ -n "$CI_COMMIT_TAG" ]; then
      export IMAGE_TAG="$CI_COMMIT_REF_NAME"
    else
      export IMAGE_TAG="dev"
    fi
  script: |
    echo "Scanning Docker image for vulnerabilities: ${IMAGE_NAME}:${IMAGE_TAG}"
    trivy image --input image.tar --exit-code 0 --severity HIGH,CRITICAL --format table
    trivy image --input image.tar --exit-code 0 --severity HIGH,CRITICAL --format json --output gl-container-scanning-report.json || true
    echo "Security scan completed"
  artifacts:
    reports:
      container_scanning: gl-container-scanning-report.json
    paths:
      - gl-container-scanning-report.json
    expire_in: 1 week
    when: always
  allow_failure: true
  only:
    - branches
    - tags

# Push Docker image to Docker Hub
docker-push:
  stage: publish
  image: docker:24-dind
  services:
    - docker:24-dind
  dependencies:
    - docker-build
    - trivy-scan
  before_script: |
    # Compute image tag: use Git tag name if available, otherwise "dev"
    if [ -n "$CI_COMMIT_TAG" ]; then
      export IMAGE_TAG="$CI_COMMIT_REF_NAME"
      echo "Pushing release image with tag: $IMAGE_TAG"
    else
      export IMAGE_TAG="dev"
      echo "Pushing dev image with tag: $IMAGE_TAG"
    fi
    echo "Loading Docker image from artifact..."
    docker load -i image.tar
    echo "Logging in to Docker Hub..."
    echo "$DOCKER_REGISTRY_PASSWORD" | docker login -u "$DOCKER_REGISTRY_USER" --password-stdin
    echo "Pushing Docker image: ${IMAGE_NAME}:${IMAGE_TAG}"
  script:
    - docker push ${IMAGE_NAME}:${IMAGE_TAG}
    - |
      if [ -n "$CI_COMMIT_TAG" ]; then
        echo "Pushing latest tag for release..."
        docker push ${IMAGE_NAME}:latest
      fi
    - echo "Docker image pushed successfully"
  after_script:
    - docker logout
  only:
    - branches
    - tags
